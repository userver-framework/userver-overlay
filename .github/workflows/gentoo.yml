name: Gentoo Systemd CI with binpkg

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  gentoo-userver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Gentoo Docker image
        run: |
          docker build -t gentoo-systemd -f docker/gentoo/systemd.Dockerfile .

      - name: Start Gentoo container
        run: |
          docker run --privileged -d \
            --name gentoo-test \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            gentoo-systemd /sbin/init
          echo "Waiting for systemd to initialize..."
          sleep 15
          docker ps | grep gentoo-test

      # ---------- DOWNLOAD & UNPACK BINPKGS ----------

      - name: Download and unpack prebuilt binpkg archive
        run: |
          docker exec gentoo-test bash -lc '
            set -e
            mkdir -p /var/cache/binpkgs
            cd /var/cache/binpkgs
            wget -q -O packages.tar.zst "https://github.com/userver-framework/userver-gentoo-heavy-deps/releases/download/archive1/packages.tar.zst"
            tar --zstd -xvf packages.tar.zst
            rm -f packages.tar.zst
          '

      # ---------- Sync Gentoo tree ----------

      - name: Sync gentoo tree
        run: |
          docker exec gentoo-test bash -lc 'emerge-webrsync'

      # ---------- USE flags ----------

      - name: Configure USE flags
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.use

            # userver main package
            echo "dev-cpp/userver postgres redis mongodb mysql rabbitmq kafka sqlite utest odbc" > /etc/portage/package.use/userver

            # Dependencies with explicit USE flags only
            echo "dev-libs/re2 icu" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/cyrus-sasl static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-lang/python ssl" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/crypto++ static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/libbson static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/libev static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/openssl static-libs" >> /etc/portage/package.use/userver-deps
            echo "net-dns/c-ares static-libs" >> /etc/portage/package.use/userver-deps
            echo "net-misc/curl static-libs" >> /etc/portage/package.use/userver-deps
            echo "net-nds/openldap static-libs" >> /etc/portage/package.use/userver-deps
            echo "sys-libs/zlib static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/hiredis static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/mongo-c-driver static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-db/postgresql static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-db/unixODBC static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/jemalloc stats" >> /etc/portage/package.use/userver-deps
          '

      # ---------- Base tools ----------

      - name: Install eselect-repository and git
        run: |
          docker exec gentoo-test bash -lc 'emerge -v app-eselect/eselect-repository dev-vcs/git'

      # ---------- Overlay ----------

      - name: Register and clone userver overlay
        run: |
          docker exec gentoo-test bash -lc '
            eselect repository add userver-framework git https://github.com/userver-framework/userver-overlay.git || true
            rm -rf /var/db/repos/userver-framework
            git clone --depth=1 https://github.com/userver-framework/userver-overlay.git /var/db/repos/userver-framework
          '

      # ---------- Install from binpkg ----------

      - name: Install LLVM toolchain from binpkg
        run: |
          docker exec gentoo-test bash -lc '
            emerge -vk llvm-core/llvm llvm-core/clang dev-build/cmake dev-build/ninja dev-util/ccache dev-lang/go
          '

      - name: Install heavy deps from binpkg
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.license
            echo "dev-db/mongodb SSPL-1" > /etc/portage/package.license/mongodb
            emerge -vk dev-db/postgresql dev-db/mongodb dev-db/redis dev-db/mariadb dev-cpp/amqp-cpp dev-libs/librdkafka
          '

      - name: Install userver from binpkg
        run: |
          docker exec gentoo-test bash -lc '
            emerge -vk dev-cpp/userver
          '

      # ---------- Build, test and smoke-test userver ----------

      - name: Build, test, and smoke-test userver service
        run: |
          docker exec gentoo-test bash -lc '
            set -e
            cd /root
            userver-create-service myservice
            cd myservice

            echo ">>> Build and run tests"
            make build-debug
            make test-debug

            echo ">>> Start service for smoke test"
            make start-debug &
            PID=$!
            sleep 5

            echo ">>> Smoke test: check HTTP endpoint"
            RESPONSE=$(curl -fs http://127.0.0.1:8080/hello?name=userver)
            echo "Response: $RESPONSE"
            if [ "$RESPONSE" != "Hello, userver!" ]; then
              echo "ERROR: unexpected response"
              exit 1
            fi

            kill $PID || true
          '

      - name: Debug info
        if: always()
        run: |
          docker exec gentoo-test bash -lc 'emerge -pv dev-cpp/userver'
