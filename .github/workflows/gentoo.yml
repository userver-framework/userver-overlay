name: Gentoo Systemd with Overlay CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  gentoo-userver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Build Gentoo base image ----------
      - name: Build Gentoo image
        run: |
          docker build -t gentoo-systemd -f docker/gentoo/systemd.Dockerfile .

      - name: Run Gentoo container (systemd)
        run: |
          docker run --privileged -d \
            --name gentoo-test \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            gentoo-systemd /sbin/init

          echo "Waiting for systemd to initialize..."
          sleep 15
          docker ps | grep gentoo-test

      # ---------- Sync Gentoo tree ----------
      - name: Sync gentoo tree (webrsync)
        run: |
          docker exec gentoo-test bash -lc 'emerge-webrsync'

      # ---------- Configure USE flags for userver and dependencies ----------
      - name: Configure USE flags
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.use

            # userver main package
            echo "dev-cpp/userver postgres redis mongodb mysql rabbitmq kafka sqlite utest odbc" > /etc/portage/package.use/userver

            # Dependencies with explicit USE flags only
            echo "dev-libs/re2 icu" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/cyrus-sasl static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-lang/python ssl" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/crypto++ static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/libbson static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/libev static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/openssl static-libs" >> /etc/portage/package.use/userver-deps
            echo "net-dns/c-ares static-libs" >> /etc/portage/package.use/userver-deps
            echo "net-misc/curl static-libs" >> /etc/portage/package.use/userver-deps
            echo "net-nds/openldap static-libs" >> /etc/portage/package.use/userver-deps
            echo "sys-libs/zlib static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/hiredis static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/mongo-c-driver static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-db/postgresql static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-db/unixODBC static-libs" >> /etc/portage/package.use/userver-deps
            echo "dev-libs/jemalloc stats" >> /etc/portage/package.use/userver-deps
          '

      # ---------- Configure USE flags for heavy binpkg ----------
      - name: Configure USE flags for binpkgs
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.use

            echo "dev-build/ninja -doc -test" > /etc/portage/package.use/ninja
            echo "dev-build/cmake ncurses -dap -doc -gui -test -verify-sig" > /etc/portage/package.use/cmake
            echo "dev-util/ccache static-c++ -doc -redis -test -verify-sig" > /etc/portage/package.use/ccache
            echo "llvm-core/llvm binutils-plugin libffi zstd -debug -doc -exegesis -libedit -test -verify-sig -xml -z3" > /etc/portage/package.use/llvm
            echo "llvm-core/clang extra pie static-analyzer -debug -doc -test -verify-sig -xml" > /etc/portage/package.use/clang
            echo "dev-libs/boost bzip2 context nls stacktrace zlib -debug -doc -icu -lzma -mpi -numpy -python -test -test-full -tools -zstd" > /etc/portage/package.use/boost
            echo "dev-db/postgresql icu lz4 nls numa pam readline server ssl static-libs systemd uring zlib zstd -debug -doc -kerberos -ldap -llvm -oauth -perl -python -tcl -uuid -xml" > /etc/portage/package.use/postgresql
            echo "dev-db/redis jemalloc ssl systemd -tcmalloc -test" > /etc/portage/package.use/redis
            echo "dev-db/mariadb backup pam perl server systemd -bindist -columnstore -cracklib -debug -extraengine -galera -innodb-lz4 -innodb-lzo -innodb-snappy -jdbc -jemalloc -kerberos -latin1 -numa -odbc -oqgraph -profiling -rocksdb -s3 -sphinx -sst-mariabackup -sst-rsync -static -systemtap -tcmalloc -test -xml -yassl" > /etc/portage/package.use/mariadb
            echo "dev-db/mongodb ssl tools -debug -kerberos -mongosh" > /etc/portage/package.use/mongodb
            echo "dev-libs/librdkafka lz4 ssl zstd -sasl -static-libs" > /etc/portage/package.use/librdkafka
          '

      # ---------- Accept SSPL license for MongoDB ----------
      - name: Accept MongoDB SSPL license
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.license
            echo "dev-db/mongodb SSPL-1" >> /etc/portage/package.license/mongodb
          '

      # ---------- Configure CPU_FLAGS / ABI / PYTHON targets ----------
      - name: Configure CPU_FLAGS and env for binpkgs
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/env
            mkdir -p /etc/portage/package.env

            # go
            echo "CPU_FLAGS_X86=\"sse2\"" > /etc/portage/env/go
            echo "dev-lang/go go" > /etc/portage/package.env/go

            # llvm / clang
            echo "ABI_X86=\"64\"" > /etc/portage/env/llvm
            echo "LLVM_TARGETS=\"AArch64 AMDGPU ARM AVR BPF Hexagon Lanai LoongArch MSP430 Mips NVPTX PowerPC RISCV SPIRV Sparc SystemZ VE WebAssembly X86 XCore\"" >> /etc/portage/env/llvm
            echo "dev-build/llvm llvm" > /etc/portage/package.env/llvm

            echo "ABI_X86=\"64\"" > /etc/portage/env/clang
            echo "PYTHON_SINGLE_TARGET=\"python3_13\"" >> /etc/portage/env/clang
            echo "dev-build/clang clang" > /etc/portage/package.env/clang

            # boost
            echo "ABI_X86=\"64\"" > /etc/portage/env/boost
            echo "PYTHON_TARGETS=\"python3_13\"" >> /etc/portage/env/boost
            echo "dev-libs/boost boost" > /etc/portage/package.env/boost

            # postgresql
            echo "LLVM_SLOT=\"21\"" > /etc/portage/env/postgresql
            echo "PYTHON_SINGLE_TARGET=\"python3_13\"" >> /etc/portage/env/postgresql
            echo "dev-db/postgresql postgresql" > /etc/portage/package.env/postgresql
          '

      # ---------- Install curl ----------
      - name: Install curl
        run: |
          docker exec gentoo-test bash -lc 'emerge net-misc/curl'

      # ---------- Download and extract prebuilt binpkg ----------
      - name: Download and extract binpkg archive
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /var/cache/binpkgs
            cd /var/cache/binpkgs
            curl -L -o packages.tar.zst https://github.com/userver-framework/userver-gentoo-heavy-deps/releases/download/archive1/packages.tar.zst
            tar --zstd -xf packages.tar.zst
            rm packages.tar.zst
          '

      # ---------- Install heavy packages from binpkg ----------
      - name: Install heavy packages from binpkg
        run: |
          docker exec gentoo-test bash -lc '
            emerge --getbinpkg \
              dev-build/ninja \
              dev-build/cmake \
              dev-util/ccache \
              llvm-core/llvm \
              llvm-core/clang \
              dev-libs/boost \
              dev-db/postgresql \
              dev-db/redis \
              dev-db/mariadb \
              dev-db/mongodb \
              dev-libs/librdkafka
          '

      # ---------- Build userver ----------
      - name: Build userver
        run: |
          docker exec gentoo-test bash -lc 'emerge -v dev-cpp/userver'

      # ---------- Test userver ----------
      - name: Build & test userver debug
        run: |
          docker exec gentoo-test bash -lc '
            cd /usr/src/userver-sample
            make build-debug
            make test-debug
            make start-debug &
            sleep 10
            curl -s http://127.0.0.1:8080/hello?name=userver | grep "Hello, userver!"
          '

      # ---------- Debug info ----------
      - name: Debug info
        if: always()
        run: |
          docker exec gentoo-test bash -lc 'emerge -pv dev-cpp/userver'
