name: Gentoo Systemd with Overlay CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  gentoo-userver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Gentoo image
        run: |
          docker build -t gentoo-systemd -f docker/gentoo/systemd.Dockerfile .

      - name: Run Gentoo container (systemd)
        run: |
          docker run --privileged -d \
            --name gentoo-test \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            gentoo-systemd /sbin/init

          echo "Waiting for systemd to initialize..."
          sleep 15
          echo "Container status:"
          docker ps | grep gentoo-test

      # ---------- Gentoo tree ----------

      - name: Sync gentoo tree (webrsync)
        run: |
          docker exec gentoo-test bash -lc '
            emerge-webrsync
          '

      # ---------- Overlay ----------

      - name: Register userver overlay
        run: |
          docker exec gentoo-test bash -lc '
            eselect repository add userver-framework git https://github.com/userver-framework/userver-overlay.git || true
          '

      - name: Clone userver overlay
        run: |
          docker exec gentoo-test bash -lc '
            rm -rf /var/db/repos/userver-framework
            git clone --depth=1 https://github.com/userver-framework/userver-overlay.git \
              /var/db/repos/userver-framework
          '

      # ---------- USE flags ----------

      - name: Configure USE flags
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.use

            # userver: все реальные IUSE в одной строке
            cat > /etc/portage/package.use/userver << "EOF"
dev-cpp/userver postgres redis mongodb mysql rabbitmq kafka sqlite utest testsuite easy odbc uboost-coro
EOF

            # dependency USE flags, которые userver требует от зависимостей
            cat > /etc/portage/package.use/userver-deps << "EOF"
dev-libs/cyrus-sasl static-libs
dev-db/unixODBC static-libs
dev-lang/python ssl
dev-libs/crypto++ static-libs
dev-libs/libbson static-libs
dev-libs/libev static-libs
dev-libs/openssl static-libs
net-dns/c-ares static-libs
net-misc/curl static-libs
net-nds/openldap static-libs
sys-libs/zlib static-libs

dev-db/postgresql static-libs
dev-libs/hiredis static-libs
dev-libs/mongo-c-driver static-libs
EOF
          '

      # ---------- Base toolchain ----------

      - name: Build base toolchain
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v \
              sys-devel/clang \
              dev-build/cmake \
              dev-build/ninja \
              dev-vcs/git \
              dev-util/ccache
          '

      # ---------- Heavy dependencies (1 package = 1 step) ----------

      - name: Build PostgreSQL
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-db/postgresql
          '

      - name: Build MongoDB
        run: |
          docker exec gentoo-test bash -lc '
            FEATURES="-sandbox -ipc-sandbox -network-sandbox" emerge -v dev-db/mongodb
          '

      - name: Build Redis
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-db/redis
          '

      - name: Build MariaDB
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-db/mariadb
          '

      - name: Build RabbitMQ dependency
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-cpp/amqp-cpp
          '

      - name: Build Kafka dependency
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-libs/librdkafka
          '

      # ---------- userver ----------

      - name: Build userver
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-cpp/userver
          '

      - name: Debug info
        if: always()
        run: |
          docker exec gentoo-test bash -lc '
            emerge -pv dev-cpp/userver
          '

