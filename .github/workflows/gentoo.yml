name: Gentoo Systemd with Overlay CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  gentoo-userver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Gentoo image
        run: |
          docker build -t gentoo-systemd -f docker/gentoo/systemd.Dockerfile .

      - name: Run Gentoo container (systemd)
        run: |
          docker run --privileged -d \
            --name gentoo-test \
            --cgroupns=host \
            -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
            gentoo-systemd /sbin/init

          echo "Waiting for systemd to initialize..."
          sleep 15
          echo "Container status:"
          docker ps | grep gentoo-test

      # ---------- Gentoo tree ----------

      - name: Sync gentoo tree (webrsync)
        run: |
          docker exec gentoo-test bash -lc '
            emerge-webrsync
          '

      # ---------- USE flags (BEFORE any installs) ----------

      - name: Configure USE flags
        run: |
          docker exec gentoo-test bash -lc '
            mkdir -p /etc/portage/package.use

            echo "dev-cpp/userver postgres redis mongodb mysql rabbitmq kafka sqlite utest testsuite easy odbc uboost-coro" \
              > /etc/portage/package.use/userver

            echo "dev-libs/cyrus-sasl static-libs"        >> /etc/portage/package.use/userver-deps
            echo "dev-db/unixODBC static-libs"            >> /etc/portage/package.use/userver-deps
            echo "dev-lang/python ssl"                    >> /etc/portage/package.use/userver-deps
            echo "dev-libs/crypto++ static-libs"          >> /etc/portage/package.use/userver-deps
            echo "dev-libs/libbson static-libs"           >> /etc/portage/package.use/userver-deps
            echo "dev-libs/libev static-libs"             >> /etc/portage/package.use/userver-deps
            echo "dev-libs/openssl static-libs"           >> /etc/portage/package.use/userver-deps
            echo "net-dns/c-ares static-libs"             >> /etc/portage/package.use/userver-deps
            echo "net-misc/curl static-libs"              >> /etc/portage/package.use/userver-deps
            echo "net-nds/openldap static-libs"           >> /etc/portage/package.use/userver-deps
            echo "sys-libs/zlib static-libs"              >> /etc/portage/package.use/userver-deps

            echo "dev-db/postgresql static-libs"          >> /etc/portage/package.use/userver-deps
            echo "dev-libs/hiredis static-libs"           >> /etc/portage/package.use/userver-deps
            echo "dev-libs/mongo-c-driver static-libs"    >> /etc/portage/package.use/userver-deps
          '

      # ---------- Base tools needed for overlay ----------

      - name: Install eselect-repository and git
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v app-eselect/eselect-repository dev-vcs/git
          '

      # ---------- Overlay ----------

      - name: Register userver overlay
        run: |
          docker exec gentoo-test bash -lc '
            eselect repository add userver-framework git https://github.com/userver-framework/userver-overlay.git || true
          '

      - name: Clone userver overlay
        run: |
          docker exec gentoo-test bash -lc '
            rm -rf /var/db/repos/userver-framework
            git clone --depth=1 https://github.com/userver-framework/userver-overlay.git /var/db/repos/userver-framework
          '

      # ---------- Base toolchain ----------

      - name: Build base toolchain
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v \
              llvm-core/clang \
              dev-build/cmake \
              dev-build/ninja \
              dev-util/ccache
          '

      # ---------- Heavy dependencies (1 package = 1 step) ----------

      - name: Build PostgreSQL
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-db/postgresql
          '

      - name: Build MongoDB
        run: |
          docker exec gentoo-test bash -lc '
            FEATURES="-sandbox -ipc-sandbox -network-sandbox" emerge -v dev-db/mongodb
          '

      - name: Build Redis
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-db/redis
          '

      - name: Build MariaDB
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-db/mariadb
          '

      - name: Build RabbitMQ dependency
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-cpp/amqp-cpp
          '

      - name: Build Kafka dependency
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-libs/librdkafka
          '

      # ---------- userver ----------

      - name: Build userver
        run: |
          docker exec gentoo-test bash -lc '
            emerge -v dev-cpp/userver
          '

      - name: Debug info
        if: always()
        run: |
          docker exec gentoo-test bash -lc '
            emerge -pv dev-cpp/userver
          '
